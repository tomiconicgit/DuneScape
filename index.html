<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DuneScape - Enhanced 3D RPG Adventure</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    
    <script src="https://unpkg.com/cannon-es@0.20.0/dist/cannon-es.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #0c0c0f;
            color: #e0e0e0;
            overflow: hidden;
            touch-action: none;
            height: 100vh;
            width: 100vw;
        }
        
        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        #ui-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }
        
        #ui-container > * {
            pointer-events: auto;
        }
        
        /* Header Bar */
        .header-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%);
        }
        
        .player-stats {
            display: flex;
            gap: 15px;
        }
        
        .stat {
            display: flex;
            align-items: center;
            background: rgba(40, 40, 45, 0.8);
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid rgba(100, 100, 120, 0.4);
        }
        
        .stat i {
            margin-right: 8px;
            color: #ffcc00;
        }
        
        .health-bar {
            width: 120px;
            height: 12px;
            background: rgba(80, 0, 0, 0.6);
            border-radius: 6px;
            overflow: hidden;
            margin-left: 8px;
        }
        
        .health-fill {
            height: 100%;
            width: 80%;
            background: linear-gradient(to right, #ff0000, #ff8800);
            border-radius: 6px;
            transition: width 0.3s;
        }
        
        /* Minimap */
        .minimap {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 120px;
            height: 120px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            border: 3px solid #555;
            overflow: hidden;
        }
        
        /* Bottom Navigation */
        .nav-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%);
        }
        
        .nav-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(60, 60, 70, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid rgba(100, 100, 120, 0.4);
            transition: all 0.2s;
        }
        
        .nav-btn:hover {
            transform: translateY(-5px);
            background: rgba(80, 80, 90, 0.9);
        }
        
        .nav-btn i {
            font-size: 20px;
            margin-bottom: 4px;
            color: #ffcc00;
        }
        
        .nav-btn span {
            font-size: 10px;
            color: #ccc;
        }
        
        /* Panels */
        .panel {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            background: rgba(30, 30, 35, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            display: none;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 204, 0, 0.3);
        }
        
        .panel-title {
            font-size: 1.2rem;
            color: #ffcc00;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #ccc;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        /* Mission Panel */
        .mission-item {
            background: rgba(50, 50, 55, 0.8);
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #ffcc00;
        }
        
        .mission-title {
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }
        
        .mission-desc {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 10px;
        }
        
        .mission-reward {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            color: #ffcc00;
        }
        
        .start-btn {
            background: linear-gradient(to right, #ff9900, #ffcc00);
            color: #332200;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.2s;
        }
        
        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
        }
        
        /* Inventory Panel */
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .inventory-slot {
            aspect-ratio: 1;
            background: rgba(50, 50, 55, 0.8);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(100, 100, 120, 0.4);
        }
        
        .inventory-slot i {
            font-size: 24px;
            margin-bottom: 5px;
            color: #ffcc00;
        }
        
        .inventory-slot span {
            font-size: 12px;
            color: #ccc;
        }
        
        /* Levels Panel */
        .skill-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: rgba(50, 50, 55, 0.8);
            margin-bottom: 8px;
            border-radius: 8px;
        }
        
        .skill-icon {
            width: 40px;
            height: 40px;
            background: rgba(70, 70, 80, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }
        
        .skill-icon i {
            color: #ffcc00;
        }
        
        .skill-info {
            flex-grow: 1;
        }
        
        .skill-name {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .skill-level {
            font-size: 0.85rem;
            color: #aaa;
        }
        
        .xp-bar {
            height: 6px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .xp-fill {
            height: 100%;
            width: 30%;
            background: linear-gradient(to right, #00ccff, #0066ff);
            border-radius: 3px;
        }
        
        /* Modals */
        .modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 400px;
            background: rgba(30, 30, 35, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
            z-index: 10;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .modal-title {
            font-size: 1.5rem;
            color: #ffcc00;
            margin-bottom: 15px;
        }
        
        .modal-text {
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .modal-btn {
            background: linear-gradient(to right, #ff9900, #ffcc00);
            color: #332200;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.2s;
        }
        
        .modal-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 204, 0, 0.5);
        }
        
        #welcome-modal {
            display: block;
        }
        
        #death-modal {
            display: none;
        }
        
        /* Toast Notifications */
        .toast {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(50, 50, 55, 0.95);
            padding: 12px 20px;
            border-radius: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            z-index: 5;
            animation: toastAnimation 3s forwards;
            backdrop-filter: blur(5px);
        }
        
        @keyframes toastAnimation {
            0% { top: -50px; opacity: 0; }
            10% { top: 20px; opacity: 1; }
            90% { top: 20px; opacity: 1; }
            100% { top: -50px; opacity: 0; }
        }
        
        .toast i {
            margin-right: 10px;
            color: #ffcc00;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .stat {
                padding: 6px 10px;
            }
            
            .health-bar {
                width: 80px;
            }
            
            .minimap {
                width: 100px;
                height: 100px;
            }
            
            .nav-btn {
                width: 50px;
                height: 50px;
            }
            
            .nav-btn i {
                font-size: 18px;
            }
        }
        
        @media (max-width: 480px) {
            .player-stats {
                gap: 8px;
            }
            
            .stat {
                padding: 5px 8px;
                font-size: 14px;
            }
            
            .health-bar {
                width: 60px;
            }
            
            .minimap {
                width: 80px;
                height: 80px;
            }
            
            .nav-btn {
                width: 45px;
                height: 45px;
            }
            
            .nav-btn i {
                font-size: 16px;
            }
            
            .nav-btn span {
                font-size: 9px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="canvas-container"></div>
        
        <div id="ui-container">
            <div class="header-bar">
                <div class="player-stats">
                    <div class="stat">
                        <i class="fas fa-coins"></i>
                        <span id="gold-amount">1250</span>
                    </div>
                    <div class="stat">
                        <i class="fas fa-heart"></i>
                        <span id="health-amount">80/100</span>
                        <div class="health-bar">
                            <div class="health-fill" id="health-fill"></div>
                        </div>
                    </div>
                </div>
                
                <div class="minimap" id="minimap">
                    </div>
            </div>
            
            <div class="nav-bar">
                <div class="nav-btn" id="inventory-btn">
                    <i class="fas fa-backpack"></i>
                    <span>Items</span>
                </div>
                <div class="nav-btn" id="skills-btn">
                    <i class="fas fa-chart-line"></i>
                    <span>Skills</span>
                </div>
                <div class="nav-btn" id="missions-btn">
                    <i class="fas fa-scroll"></i>
                    <span>Quests</span>
                </div>
                <div class="nav-btn" id="map-btn">
                    <i class="fas fa-map"></i>
                    <span>Map</span>
                </div>
                <div class="nav-btn" id="settings-btn">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </div>
            </div>
            
            <div class="panel" id="inventory-panel">
                <div class="panel-header">
                    <h2 class="panel-title">Inventory</h2>
                    <button class="close-btn">&times;</button>
                </div>
                <div class="inventory-grid">
                    <div class="inventory-slot">
                        <i class="fas fa-tree"></i>
                        <span>Wood</span>
                    </div>
                    <div class="inventory-slot">
                        <i class="fas fa-gem"></i>
                        <span>Ore</span>
                    </div>
                    <div class="inventory-slot">
                        <i class="fas fa-shield-alt"></i>
                        <span>Shield</span>
                    </div>
                    <div class="inventory-slot">
                        <i class="fas fa-ring"></i>
                        <span>Ring</span>
                    </div>
                    <div class="inventory-slot">
                        <i class="fas fa-hat-wizard"></i>
                        <span>Hat</span>
                    </div>
                    <div class="inventory-slot">
                        <i class="fas fa-fire"></i>
                        <span>Rune</span>
                    </div>
                    <div class="inventory-slot">
                        <i class="fas fa-fish"></i>
                        <span>Fish</span>
                    </div>
                    <div class="inventory-slot">
                        <i class="fas fa-potion"></i>
                        <span>Potion</span>
                    </div>
                </div>
            </div>
            
            <div class="panel" id="skills-panel">
                <div class="panel-header">
                    <h2 class="panel-title">Skills & Levels</h2>
                    <button class="close-btn">&times;</button>
                </div>
                <div class="skills-list">
                    <div class="skill-item">
                        <div class="skill-icon">
                            <i class="fas fa-fist-raised"></i>
                        </div>
                        <div class="skill-info">
                            <div class="skill-name">Combat</div>
                            <div class="skill-level">Level 5</div>
                            <div class="xp-bar">
                                <div class="xp-fill" style="width: 45%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="skill-item">
                        <div class="skill-icon">
                            <i class="fas fa-tree"></i>
                        </div>
                        <div class="skill-info">
                            <div class="skill-name">Woodcutting</div>
                            <div class="skill-level">Level 3</div>
                            <div class="xp-bar">
                                <div class="xp-fill" style="width: 70%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="skill-item">
                        <div class="skill-icon">
                            <i class="fas fa-mountain"></i>
                        </div>
                        <div class="skill-info">
                            <div class="skill-name">Mining</div>
                            <div class="skill-level">Level 2</div>
                            <div class="xp-bar">
                                <div class="xp-fill" style="width: 30%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="skill-item">
                        <div class="skill-icon">
                            <i class="fas fa-fish"></i>
                        </div>
                        <div class="skill-info">
                            <div class="skill-name">Fishing</div>
                            <div class="skill-level">Level 4</div>
                            <div class="xp-bar">
                                <div class="xp-fill" style="width: 20%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="panel" id="missions-panel">
                <div class="panel-header">
                    <h2 class="panel-title">Missions</h2>
                    <button class="close-btn">&times;</button>
                </div>
                <div class="missions-list">
                    <div class="mission-item">
                        <div class="mission-title">
                            <span>Chop 5 Trees</span>
                            <span>★</span>
                        </div>
                        <div class="mission-desc">
                            Gather wood from trees in the forest
                        </div>
                        <div class="mission-reward">
                            <i class="fas fa-coins"></i>
                            <span>Reward: 100 Gold</span>
                        </div>
                        <button class="start-btn">Start Mission</button>
                    </div>
                    <div class="mission-item">
                        <div class="mission-title">
                            <span>Defeat 3 Goblins</span>
                            <span>★★</span>
                        </div>
                        <div class="mission-desc">
                            Find and defeat goblins in the desert
                        </div>
                        <div class="mission-reward">
                            <i class="fas fa-coins"></i>
                            <span>Reward: 200 Gold</span>
                        </div>
                        <button class="start-btn">Start Mission</button>
                    </div>
                    <div class="mission-item">
                        <div class="mission-title">
                            <span>Mine Iron Ore</span>
                            <span>★</span>
                        </div>
                        <div class="mission-desc">
                            Gather iron from the mountains
                        </div>
                        <div class="mission-reward">
                            <i class="fas fa-coins"></i>
                            <span>Reward: 150 Gold</span>
                        </div>
                        <button class="start-btn">Start Mission</button>
                    </div>
                </div>
            </div>
            
            <div class="modal" id="welcome-modal">
                <h2 class="modal-title">Welcome to DuneScape</h2>
                <p class="modal-text">
                    Embark on an epic adventure in a vast desert world. 
                    Complete missions, gather resources, and defeat enemies to become the ultimate champion!
                </p>
                <button class="modal-btn" id="start-btn">Start Exploring</button>
            </div>
            
            <div class="modal" id="death-modal">
                <h2 class="modal-title">You Died</h2>
                <p class="modal-text">
                    Your journey has come to an end... for now.
                    You will lose some items but keep your skills and experience.
                </p>
                <button class="modal-btn" id="respawn-btn">Respawn</button>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { SMAAPass } from 'three/addons/postprocessing/SMAAPass.js';

        // Game state and configuration
        const gameState = {
            initialized: false,
            player: {
                health: 80,
                maxHealth: 100,
                gold: 1250,
                position: { x: 0, y: 0, z: 0 },
                rotation: { x: 0, y: 0, z: 0 },
                mesh: null,
                body: null
            },
            skills: {
                combat: { level: 5, xp: 45 },
                woodcutting: { level: 3, xp: 70 },
                mining: { level: 2, xp: 30 },
                fishing: { level: 4, xp: 20 }
            },
            inventory: ['wood', 'ore', 'shield', 'ring', 'hat', 'rune', 'fish', 'potion'],
            currentMission: null,
            scene: null,
            camera: null,
            renderer: null,
            composer: null,
            controls: null,
            physicsWorld: null,
            minimapCamera: null,
            minimapRenderer: null,
            enemies: [],
            clock: new THREE.Clock()
        };

        // Simple Perlin noise function for terrain
        function perlinNoise(x, y) {
            const p = new Array(512);
            const permutation = [151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180];
            for (let i = 0; i < 256; i++) p[256 + i] = p[i] = permutation[i];

            const fade = t => t * t * t * (t * (t * 6 - 15) + 10);
            const lerp = (t, a, b) => a + t * (b - a);
            const grad = (hash, x, y) => {
                const h = hash & 15;
                const u = h < 8 ? x : y;
                const v = h < 4 ? y : h === 12 || h === 14 ? x : 0;
                return ((h & 1) === 0 ? u : -u) + ((h & 2) === 0 ? v : -v);
            };

            const X = Math.floor(x) & 255;
            const Y = Math.floor(y) & 255;
            x -= Math.floor(x);
            y -= Math.floor(y);
            const u = fade(x);
            const v = fade(y);
            const aa = p[p[X] + Y];
            const ab = p[p[X] + Y + 1];
            const ba = p[p[X + 1] + Y];
            const bb = p[p[X + 1] + Y + 1];

            return lerp(v, lerp(u, grad(aa, x, y), grad(ba, x - 1, y)), lerp(u, grad(ab, x, y - 1), grad(bb, x - 1, y - 1)));
        }

        // Initialize the game
        document.addEventListener('DOMContentLoaded', function() {
            // Setup event listeners
            document.getElementById('start-btn').addEventListener('click', startGame);
            document.getElementById('respawn-btn').addEventListener('click', respawn);
            
            // Panel toggle buttons
            document.getElementById('inventory-btn').addEventListener('click', () => togglePanel('inventory-panel'));
            document.getElementById('skills-btn').addEventListener('click', () => togglePanel('skills-panel'));
            document.getElementById('missions-btn').addEventListener('click', () => togglePanel('missions-panel'));
            
            // Close buttons
            document.querySelectorAll('.close-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('.panel').style.display = 'none';
                });
            });
            
            // Mission start buttons
            document.querySelectorAll('.start-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const missionTitle = this.closest('.mission-item').querySelector('.mission-title span').textContent;
                    startMission(missionTitle);
                });
            });
            
            // Initialize Three.js
            initThreeJS();
            
            // Simulate game progress for demo purposes
            simulateGameProgress();
        });
        
        // Initialize Three.js
        function initThreeJS() {
            // Create scene
            gameState.scene = new THREE.Scene();
            gameState.scene.background = new THREE.Color(0x87CEEB); // Sky blue
            gameState.scene.fog = new THREE.Fog(0x87CEEB, 20, 100);
            
            // Create camera
            gameState.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            gameState.camera.position.set(0, 5, 10);
            
            // Create renderer
            gameState.renderer = new THREE.WebGLRenderer({ antialias: true });
            gameState.renderer.setSize(window.innerWidth, window.innerHeight);
            gameState.renderer.shadowMap.enabled = true;
            gameState.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            gameState.renderer.outputColorSpace = THREE.SRGBColorSpace;
            document.getElementById('canvas-container').appendChild(gameState.renderer.domElement);
            
            // Post-processing
            // FIX: Use imported classes without THREE prefix
            gameState.composer = new EffectComposer(gameState.renderer);
            const renderPass = new RenderPass(gameState.scene, gameState.camera);
            gameState.composer.addPass(renderPass);
            
            const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 0.5, 0.4, 0.85);
            gameState.composer.addPass(bloomPass);
            
            const smaaPass = new SMAAPass(window.innerWidth * gameState.renderer.getPixelRatio(), window.innerHeight * gameState.renderer.getPixelRatio());
            gameState.composer.addPass(smaaPass);
            
            // Controls
            // FIX: Use imported classes without THREE prefix
            gameState.controls = new OrbitControls(gameState.camera, gameState.renderer.domElement);
            gameState.controls.target.set(0, 1, 0);
            gameState.controls.update();
            
            // Physics
            gameState.physicsWorld = new CANNON.World({
                gravity: new CANNON.Vec3(0, -9.82, 0)
            });
            
            // Add lights
            const ambientLight = new THREE.AmbientLight(0x404040, 1.5);
            gameState.scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.2);
            directionalLight.position.set(10, 20, 10);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            directionalLight.shadow.camera.near = 0.5;
            directionalLight.shadow.camera.far = 500;
            directionalLight.shadow.camera.left = -50;
            directionalLight.shadow.camera.right = 50;
            directionalLight.shadow.camera.top = 50;
            directionalLight.shadow.camera.bottom = -50;
            gameState.scene.add(directionalLight);
            
            // Create desert environment
            createDesertEnvironment();
            
            // Minimap
            gameState.minimapCamera = new THREE.OrthographicCamera(-20, 20, 20, -20, 1, 100);
            gameState.minimapCamera.position.set(0, 30, 0);
            gameState.minimapCamera.lookAt(0, 0, 0);
            
            gameState.minimapRenderer = new THREE.WebGLRenderer({ alpha: true });
            gameState.minimapRenderer.setSize(120, 120);
            document.getElementById('minimap').appendChild(gameState.minimapRenderer.domElement);
            
            // Handle window resize
            window.addEventListener('resize', onWindowResize);
            
            // Start animation loop
            animate();
        }
        
        // Create desert environment
        function createDesertEnvironment() {
            // Create desert ground with better terrain
            const width = 100;
            const height = 100;
            const segments = 50;
            const groundGeometry = new THREE.PlaneGeometry(width, height, segments, segments);
            const vertices = groundGeometry.attributes.position.array;
            for (let i = 0; i < vertices.length; i += 3) {
                const x = vertices[i] / 5;
                const z = vertices[i + 2] / 5;
                vertices[i + 1] = (perlinNoise(x, z) + perlinNoise(x * 2, z * 2) / 2 + perlinNoise(x * 4, z * 4) / 4) * 3;
            }
            groundGeometry.computeVertexNormals();
            
            const groundMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xC2B280, // Sand color
                roughness: 0.9,
                metalness: 0.1,
                side: THREE.DoubleSide
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            ground.castShadow = true;
            gameState.scene.add(ground);
            
            // Ground physics
            const groundBody = new CANNON.Body({
                type: CANNON.Body.STATIC,
                shape: new CANNON.Plane()
            });
            groundBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0);
            gameState.physicsWorld.addBody(groundBody);
            
            // Add rocks
            const rockGeometry = new THREE.DodecahedronGeometry(1, 1);
            const rockMaterial = new THREE.MeshStandardMaterial({ color: 0x7A7A7A, roughness: 0.8 });
            
            for (let i = 0; i < 30; i++) {
                const rock = new THREE.Mesh(rockGeometry, rockMaterial);
                rock.position.set(
                    Math.random() * 80 - 40,
                    0,
                    Math.random() * 80 - 40
                );
                rock.scale.set(
                    Math.random() * 2 + 1,
                    Math.random() * 2 + 1,
                    Math.random() * 2 + 1
                );
                rock.rotation.set(
                    Math.random() * Math.PI,
                    Math.random() * Math.PI,
                    Math.random() * Math.PI
                );
                rock.castShadow = true;
                rock.receiveShadow = true;
                gameState.scene.add(rock);
                
                // Rock physics
                const rockBody = new CANNON.Body({
                    mass: 0,
                    shape: new CANNON.Sphere(rock.scale.x)
                });
                rockBody.position.copy(rock.position);
                gameState.physicsWorld.addBody(rockBody);
            }
            
            // Add cacti
            const cactusGeometry = new THREE.CylinderGeometry(0.3, 0.5, 3, 8);
            const cactusMaterial = new THREE.MeshStandardMaterial({ color: 0x228B22, roughness: 0.7 });
            
            for (let i = 0; i < 20; i++) {
                const cactus = new THREE.Mesh(cactusGeometry, cactusMaterial);
                cactus.position.set(
                    Math.random() * 70 - 35,
                    1.5,
                    Math.random() * 70 - 35
                );
                cactus.castShadow = true;
                cactus.receiveShadow = true;
                gameState.scene.add(cactus);
            }
            
            // Add oasis
            const waterGeometry = new THREE.CircleGeometry(5, 32);
            const waterMaterial = new THREE.MeshStandardMaterial({
                color: 0x0088FF,
                roughness: 0.2,
                metalness: 0.5,
                transparent: true,
                opacity: 0.8
            });
            const water = new THREE.Mesh(waterGeometry, waterMaterial);
            water.rotation.x = -Math.PI / 2;
            water.position.set(20, 0.01, 15);
            water.receiveShadow = true;
            gameState.scene.add(water);
            
            // Add palm trees around oasis
            for (let i = 0; i < 8; i++) {
                const angle = (i / 8) * Math.PI * 2;
                const x = 20 + Math.cos(angle) * 6;
                const z = 15 + Math.sin(angle) * 6;
                
                // Trunk
                const trunk = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.3, 0.4, 4, 8),
                    new THREE.MeshStandardMaterial({ color: 0x8B4513, roughness: 0.8 })
                );
                trunk.position.set(x, 2, z);
                trunk.castShadow = true;
                trunk.receiveShadow = true;
                gameState.scene.add(trunk);
                
                // Leaves
                const leavesGeometry = new THREE.ConeGeometry(1.5, 3, 8);
                const leavesMaterial = new THREE.MeshStandardMaterial({ color: 0x228822, roughness: 0.7 });
                const leaves = new THREE.Mesh(leavesGeometry, leavesMaterial);
                leaves.position.set(0, 3, 0);
                leaves.castShadow = true;
                leaves.receiveShadow = true;
                trunk.add(leaves);
            }
            
            // Load player model
            // FIX: Use imported classes without THREE prefix
            const loader = new GLTFLoader();
            loader.load('https://threejs.org/examples/models/gltf/Soldier.glb', function (gltf) {
                gameState.player.mesh = gltf.scene;
                gameState.player.mesh.scale.set(1, 1, 1);
                gameState.player.mesh.position.set(0, 0, 0);
                gameState.player.mesh.castShadow = true;
                gameState.player.mesh.receiveShadow = true;
                gameState.scene.add(gameState.player.mesh);
                
                // Player physics
                gameState.player.body = new CANNON.Body({
                    mass: 1,
                    shape: new CANNON.Box(new CANNON.Vec3(0.5, 1, 0.5))
                });
                gameState.player.body.position.set(0, 1, 0);
                gameState.physicsWorld.addBody(gameState.player.body);
            }, undefined, function (error) {
                console.error(error);
            });
            
            // Add enemies (goblins)
            for (let i = 0; i < 5; i++) {
                loader.load('https://threejs.org/examples/models/gltf/Soldier.glb', function (gltf) {
                    const enemyMesh = gltf.scene;
                    enemyMesh.scale.set(1, 1, 1);
                    enemyMesh.position.set(
                        Math.random() * 60 - 30,
                        0,
                        Math.random() * 60 - 30
                    );
                    enemyMesh.castShadow = true;
                    enemyMesh.receiveShadow = true;
                    gameState.scene.add(enemyMesh);
                    
                    const enemyBody = new CANNON.Body({
                        mass: 1,
                        shape: new CANNON.Box(new CANNON.Vec3(0.5, 1, 0.5))
                    });
                    enemyBody.position.copy(enemyMesh.position);
                    gameState.physicsWorld.addBody(enemyBody);
                    
                    gameState.enemies.push({ mesh: enemyMesh, body: enemyBody });
                });
            }
        }
        
        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            
            const delta = gameState.clock.getDelta();
            
            // Update physics
            if (gameState.physicsWorld) {
                gameState.physicsWorld.fixedStep();
                
                // Update player position
                if (gameState.player.mesh && gameState.player.body) {
                    gameState.player.mesh.position.copy(gameState.player.body.position);
                    gameState.player.mesh.quaternion.copy(gameState.player.body.quaternion);
                }
                
                // Update enemies
                gameState.enemies.forEach(enemy => {
                    enemy.mesh.position.copy(enemy.body.position);
                    enemy.mesh.quaternion.copy(enemy.body.quaternion);
                    
                    // Simple AI: move randomly
                    if (Math.random() < 0.01) {
                        const force = new CANNON.Vec3((Math.random() - 0.5) * 10, 0, (Math.random() - 0.5) * 10);
                        enemy.body.applyImpulse(force, enemy.body.position);
                    }
                });
            }
            
            // Update controls
            if (gameState.controls) gameState.controls.update();
            
            // Render main scene
            if (gameState.composer) {
                gameState.composer.render();
            } else if (gameState.renderer) { // Add a fallback check for renderer
                gameState.renderer.render(gameState.scene, gameState.camera);
            }
            
            // Render minimap
            if (gameState.minimapRenderer && gameState.minimapCamera && gameState.player.body) {
                gameState.minimapCamera.position.x = gameState.player.body.position.x;
                gameState.minimapCamera.position.z = gameState.player.body.position.z;
                gameState.minimapRenderer.render(gameState.scene, gameState.minimapCamera);
            }
        }
        
        // Handle window resize
        function onWindowResize() {
            gameState.camera.aspect = window.innerWidth / window.innerHeight;
            gameState.camera.updateProjectionMatrix();
            gameState.renderer.setSize(window.innerWidth, window.innerHeight);
            gameState.composer.setSize(window.innerWidth, window.innerHeight);
        }
        
        // Start the game
        function startGame() {
            document.getElementById('welcome-modal').style.display = 'none';
            gameState.initialized = true;
            
            // Show welcome notification
            showNotification('Welcome to DuneScape! Begin your adventure.');
        }
        
        // Respawn after death
        function respawn() {
            document.getElementById('death-modal').style.display = 'none';
            gameState.player.health = gameState.player.maxHealth;
            updateHealthBar();
            
            if (gameState.player.body) {
                gameState.player.body.position.set(0, 1, 0);
                gameState.player.body.velocity.set(0, 0, 0);
            }
            
            // Show respawn notification
            showNotification('You have been resurrected!');
        }
        
        // Toggle panel visibility
        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            const isVisible = panel.style.display === 'block';
            
            // Hide all panels first
            document.querySelectorAll('.panel').forEach(p => {
                p.style.display = 'none';
            });
            
            // Toggle the requested panel
            panel.style.display = isVisible ? 'none' : 'block';
        }
        
        // Start a mission
        function startMission(missionTitle) {
            gameState.currentMission = missionTitle;
            
            // Hide missions panel
            document.getElementById('missions-panel').style.display = 'none';
            
            // Show mission started notification
            showNotification('Mission started: ' + missionTitle);
            
            // Simulate mission by moving player
            if (gameState.player.body) {
                gameState.player.body.velocity.set(5, 0, 0); // Move right
            }
            
            // Simulate mission completion after delay
            setTimeout(completeMission, 5000);
        }
        
        // Complete the current mission
        function completeMission() {
            if (!gameState.currentMission) return;
            
            // Reward player
            const reward = 100 + Math.floor(Math.random() * 150);
            gameState.player.gold += reward;
            updateGoldDisplay();
            
            // Show completion notification
            showNotification('Mission complete! Received ' + reward + ' gold.');
            
            // Reset mission
            gameState.currentMission = null;
            if (gameState.player.body) {
                gameState.player.body.velocity.set(0, 0, 0);
            }
        }
        
        // Update health bar display
        function updateHealthBar() {
            const healthPercent = (gameState.player.health / gameState.player.maxHealth) * 100;
            document.getElementById('health-fill').style.width = healthPercent + '%';
            document.getElementById('health-amount').textContent = gameState.player.health + '/' + gameState.player.maxHealth;
        }
        
        // Update gold display
        function updateGoldDisplay() {
            document.getElementById('gold-amount').textContent = gameState.player.gold;
        }
        
        // Show notification toast
        function showNotification(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = '<i class="fas fa-info-circle"></i> ' + message;
            
            document.getElementById('ui-container').appendChild(toast);
            
            // Remove toast after animation
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // Simulate game progress for demo
        function simulateGameProgress() {
            // Simulate health changes
            setInterval(() => {
                if (gameState.player.health > 20 && Math.random() > 0.8) {
                    gameState.player.health -= 5;
                    updateHealthBar();
                    showNotification('You took 5 damage!');
                    
                    // Check for death
                    if (gameState.player.health <= 0) {
                        document.getElementById('death-modal').style.display = 'block';
                    }
                }
            }, 5000);
            
            // Simulate random events
            setInterval(() => {
                if (Math.random() > 0.7) {
                    const events = [
                        'A sandstorm is approaching!',
                        'Merchant arrived at the oasis.',
                        'Goblins are gathering near the canyon.',
                        'You found a rare mushroom!'
                    ];
                    showNotification(events[Math.floor(Math.random() * events.length)]);
                }
            }, 10000);
        }
    </script>
</body>
</html>
